# zk-mixer: Technical Overview

zk-mixer is a privacy-preserving Ethereum mixer leveraging zero-knowledge proofs (ZKPs) and Merkle trees, implemented with Noir circuits and Solidity smart contracts. The system enables unlinkable deposits and withdrawals of fixed-denomination ETH using zkSNARKs, with cryptographic commitments and nullifiers to prevent double-spending.

## Architecture

### 1. Cryptographic Primitives

- **Poseidon2 Hash**: All commitments, nullifier hashes, and Merkle tree nodes are computed using the Poseidon2 hash function, optimized for ZK circuits and efficient on-chain verification. Both the Noir circuit and Solidity contracts use Poseidon2 for consistency.

### 2. Merkle Tree Construction

- **Incremental Merkle Tree (IMT)**: The mixer maintains an incremental Merkle tree on-chain, implemented in `IMT.sol`, with each leaf representing a deposit commitment. The tree uses Poseidon2 for node hashing, and supports efficient root updates and historical root tracking for withdrawal verification.
- **Off-chain Merkle Proofs**: Merkle proofs are generated off-chain (see `js-scripts/MerkleTree.js`) to prove membership of a commitment in the tree. The proof consists of sibling nodes and path indices, which are provided as private inputs to the ZK circuit.

### 3. Commitment and Nullifier

- **Commitment Generation**: A deposit commitment is computed as `Poseidon2(nullifier, secret)`, where both `nullifier` and `secret` are random field elements generated off-chain (see `js-scripts/generateCommitment.ts`).
- **Nullifier Hash**: To prevent double-spending, the nullifier is hashed as `Poseidon2(nullifier)` and tracked on-chain. The nullifier hash is a public input to the circuit and contract.

### 4. Noir Circuit (`circuits/src/main.nr`)

- **Public Inputs**:
  - `root`: Merkle root (proposed by the user, must match an on-chain root)
  - `nullifier_hash`: Hash of the nullifier (prevents double-spending)
  - `recipient`: Address to receive withdrawn funds
- **Private Inputs**:
  - `nullifier`: User's secret nullifier
  - `secret`: User's deposit secret
  - `merkle_proof`: Array of sibling nodes for the Merkle path
  - `is_even`: Array of booleans indicating the position (left/right) at each tree level
- **Constraints**:
  - Validates that `Poseidon2(nullifier, secret)` is a leaf in the Merkle tree (using the provided proof)
  - Validates that `Poseidon2(nullifier) == nullifier_hash`
  - Ensures the provided root matches the computed root from the proof

### 5. Off-chain Proof Generation

- **Scripts**: Off-chain scripts (`js-scripts/generateProof.ts`) handle Merkle proof construction, witness generation, and ZK proof creation using Noir and Barretenberg. The proof and public inputs are ABI-encoded for on-chain verification.

### 6. Solidity Contracts

- **Mixer.sol**: Main contract for deposits and withdrawals. Handles:
  - Accepting fixed-denomination ETH deposits with unique commitments
  - Storing commitments in the Merkle tree
  - Verifying withdrawal proofs using the on-chain verifier and nullifier hash
  - Preventing double-spending by tracking used nullifiers
- **IMT.sol**: Implements the incremental Merkle tree with Poseidon2 hashing
- **Verifier.sol**: Verifies zkSNARK proofs generated by the Noir circuit

### 7. Security and Privacy

- **Unlinkability**: Withdrawals are unlinkable to deposits due to the use of ZKPs and random secrets
- **Double-Spend Protection**: Nullifier hashes are tracked on-chain to prevent reuse
- **Root History**: Multiple recent Merkle roots are stored to allow for proof generation against slightly outdated trees

## File Structure

- `circuits/`: Noir ZK circuit and Merkle tree logic
- `contracts/`: Solidity contracts for the mixer, Merkle tree, and verifier
- `contracts/js-scripts/`: Off-chain scripts for commitment/proof generation and Merkle tree operations

## References

- [Poseidon Hash](https://eprint.iacr.org/2019/458)
- [Noir Language](https://noir-lang.org/)
- [Barretenberg](https://github.com/AztecProtocol/barretenberg)

---

For advanced usage, see the scripts and contract source for full technical details on input encoding, proof generation, and on-chain verification.
